import{R as S}from"./chunk-GBFMXRDA-CRwfILSn.js";import{U as A,b as F,dB as B,j as s,H as C,dw as D,dC as U,dD as H,dE as z,r as K,aa as L,ad as M,B as R,a4 as v,af as w,a6 as u,a5 as E,ag as N,ah as T,aq as c}from"./index-7F_IjDe6.js";import"./chunk-2PMSBTXI-B2nk5lzI.js";import{K as V}from"./chunk-6HTZNHPT-edTwFg32.js";import{b as m,u as $}from"./chunk-4TC5YS65-Cb_suZcW.js";import"./chunk-HFB3OQXI-qTeUugb9.js";import"./x-mark-mini-DknEwfdc.js";import"./select-C7teuXXD.js";import"./check-CqO-TW3K.js";import"./triangles-mini-DfNW-wao.js";import"./plus-mini-DXss3mSX.js";import"./prompt-D8bgNQm2.js";var k=v({type:u().optional(),rules:w(v({id:u().optional(),attribute:u().min(1,{message:c.t("promotions.form.required")}),operator:u().min(1,{message:c.t("promotions.form.required")}),values:N([T().min(1,{message:c.t("promotions.form.required")}),u().min(1,{message:c.t("promotions.form.required")}),w(u()).min(1,{message:c.t("promotions.form.required")})]),required:E().optional(),disguised:E().optional(),field_type:u().optional()}))}),I=({promotion:t,ruleType:f,handleSubmit:n,isSubmitting:r})=>{const{t:d}=F(),[o,a]=K.useState([]),l=L({defaultValues:{rules:[],type:t.type},resolver:M(k)}),p=l.handleSubmit(n(o));return s.jsx(m.Form,{form:l,children:s.jsxs(V,{onSubmit:p,className:"flex h-full flex-col",children:[s.jsx(m.Body,{children:s.jsx(S,{form:l,ruleType:f,setRulesToRemove:a,rulesToRemove:o,promotion:t})}),s.jsx(m.Footer,{children:s.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[s.jsx(m.Close,{asChild:!0,children:s.jsx(R,{size:"small",variant:"secondary",disabled:r,children:d("actions.cancel")})}),s.jsx(R,{size:"small",type:"submit",isLoading:r,children:d("actions.save")})]})})]})})},O=t=>t.field_type==="number"?parseInt(t.values):t.values,W=({promotion:t,rules:f,ruleType:n})=>{const{handleSuccess:r}=$(),{mutateAsync:d}=D(t.id),{mutateAsync:o}=U(t.id,n),{mutateAsync:a}=H(t.id,n),{mutateAsync:l,isPending:p}=z(t.id,n),y=i=>async function(h){const g={},{rules:b=[]}=h,_=b.filter(e=>e.disguised),q=(i==null?void 0:i.filter(e=>e.disguised))||[];for(const e of _)g[e.attribute]=O(e);for(const e of q)g[e.attribute]=null;const x=b.filter(e=>!e.disguised),j=x.filter(e=>!("id"in e)),P=x.filter(e=>typeof e.id=="string");Object.keys(g).length&&await d({application_method:g}),j.length&&await o({rules:j.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),i!=null&&i.length&&await a({rule_ids:i.map(e=>e.id).filter(Boolean)}),P.length&&await l({rules:P.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),r()};return s.jsx(I,{promotion:t,rules:f,ruleType:n,handleSubmit:y,isSubmitting:p})},oe=()=>{var i,h;const t=A();if(!["rules","buy-rules","target-rules"].includes(t.ruleType))throw"invalid page";const{t:n}=F(),r=t.ruleType,d=t.id,o=[],{promotion:a,isPending:l,isError:p,error:y}=B(d);if(a&&(r==="rules"?o.push(...a.rules||[]):r==="target-rules"?o.push(...((i=a==null?void 0:a.application_method)==null?void 0:i.target_rules)||[]):r==="buy-rules"&&o.push(...((h=a.application_method)==null?void 0:h.buy_rules)||[])),p)throw y;return s.jsxs(m,{children:[s.jsx(m.Header,{children:s.jsx(C,{children:n(`promotions.edit.${r}.title`)})}),!l&&a&&s.jsx(W,{promotion:a,rules:o,ruleType:r})]})};export{oe as Component};
