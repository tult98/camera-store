import{D as ie}from"./chunk-IM74HYR5-DGjtSi_u.js";import{D as ne,b as ae,c as re,d as v,u as oe}from"./chunk-53RYGJCD-CpsdMJrZ.js";import{P as le}from"./chunk-AM2BU2RH-Jz_rw4zs.js";import{c as B}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as ce}from"./chunk-6HTZNHPT-edTwFg32.js";import{R as h,u as de}from"./chunk-4TC5YS65-Cb_suZcW.js";import{b as P,d as ue,r as f,j as e,aw as me,az as fe,aA as ye,aB as he,aa as ve,aC as pe,t as A,B as Q,aD as T,s as W,aE as xe,Y as je,aF as be,ac as ge,ad as _e,a4 as N,a5 as Y,ag as ke,a6 as Z,ah as Se,ae as I}from"./index-7F_IjDe6.js";import{u as Ne}from"./use-prompt-D5WG1h59.js";import"./index.esm-dHBu74Xj.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./_isIndex-l0a08DY8.js";import"./index-HhLNqBov.js";import"./checkbox-CrHB5TvK.js";import"./prompt-D8bgNQm2.js";async function we(n,o){let a=0,s=0,t=[];do{const{variants:c,count:d}=await W.admin.product.listVariants(n,{id:o,offset:a,limit:20,fields:"id,title,sku,inventory_items,inventory_items.*,inventory_items.inventory,inventory_items.inventory.id,inventory_items.inventory.title,inventory_items.inventory.sku,*inventory_items.inventory.location_levels,product.thumbnail"});t=[...t,...c],s=d,a+=20}while(t.length<s);const{stock_locations:i}=await W.admin.stockLocation.list({limit:9999,fields:"id,name"});return{variants:t,locations:i}}var et=async({params:n,request:o})=>{var i;const l=n.id,s=((i=new URLSearchParams(o.url).get(le))==null?void 0:i.split(","))||void 0,t=we(l,s);return he({data:t})},Te=({duplicateOf:n,children:o})=>{const{watchedValue:l}=oe({duplicateOf:n});return e.jsx("div",{className:"bg-ui-bg-base txt-compact-small text-ui-fg-subtle flex size-full cursor-not-allowed items-center justify-between overflow-hidden px-4 py-2.5 outline-none",children:typeof o=="function"?o({value:l}):o})};function S(n){return n.id.startsWith("variant_")}function De(n){return n.inventory_items&&n.inventory_items.length>0}function Pe(n){const o={},l={};return n.forEach(a=>{const s=a.inventory_items;s&&s.forEach(t=>{const i=o[t.inventory_item_id];if(i){l[t.inventory_item_id]={id:i.id,title:i.title||"",sku:i.sku||""};return}o[t.inventory_item_id]=a})}),l}var D=re(),Ie=(n=[],o={})=>{const{t:l}=P(),a=f.useCallback(s=>{const t=o[s.inventory_item_id],i=!!t&&t.id!==s.variant_id;return i?{isDisabled:i,item:t}:{isDisabled:!1,item:void 0}},[o]);return f.useMemo(()=>[D.column({id:"title",name:"Title",header:"Title",cell:s=>{var d,u,m,r;const t=s.row.original;if(S(t))return e.jsx(v,{context:s,children:e.jsxs("div",{className:"flex items-center gap-x-2",children:[e.jsx(xe,{size:"small",src:(d=t.product)==null?void 0:d.thumbnail}),e.jsx("span",{children:t.title||"-"})]})});const{isDisabled:i,item:c}=a(t);return i?e.jsx(v,{context:s,color:"normal",children:e.jsxs("div",{className:"flex size-full items-center justify-between gap-x-2",children:[e.jsx("span",{title:((u=t.inventory)==null?void 0:u.title)||void 0,className:"text-ui-fg-disabled",children:((m=t.inventory)==null?void 0:m.title)||"-"}),e.jsx(je,{content:c.sku?l("products.stock.tooltips.alreadyManagedWithSku",{title:c.title,sku:c.sku}):l("products.stock.tooltips.alreadyManaged",{title:c.title}),children:e.jsx(be,{})})]})}):e.jsx(v,{context:s,color:"normal",children:((r=t.inventory)==null?void 0:r.title)||"-"})},disableHiding:!0}),D.column({id:"sku",name:"SKU",header:"SKU",cell:s=>{var c,d;const t=s.row.original;if(S(t))return e.jsx(v,{context:s,children:t.sku||"-"});const{isDisabled:i}=a(t);return i?e.jsx(v,{context:s,color:"normal",children:e.jsx("span",{className:"text-ui-fg-disabled",children:((c=t.inventory)==null?void 0:c.sku)||"-"})}):e.jsx(v,{context:s,color:"normal",children:((d=t.inventory)==null?void 0:d.sku)||"-"})},disableHiding:!0}),...n.map(s=>D.column({id:`location_${s.id}`,name:s.name,header:s.name,field:t=>{const i=t.row.original;if(S(i))return null;const{isDisabled:c}=a(i);return c?null:`variants.${i.variant_id}.inventory_items.${i.inventory_item_id}.locations.${s.id}`},type:"togglable-number",cell:t=>{const i=t.row.original;if(S(i))return e.jsx(v,{context:t});const{isDisabled:c,item:d}=a(i);return c?e.jsx(Te,{duplicateOf:`variants.${d.id}.inventory_items.${i.inventory_item_id}.locations.${s.id}`,children:({value:u})=>{const{checked:m,quantity:r}=u;return e.jsxs("div",{className:"flex size-full items-center gap-x-2",children:[e.jsx(ge,{className:"shrink-0 cursor-not-allowed",tabIndex:-1,size:"small",checked:m,disabled:!0}),e.jsx("span",{className:"text-ui-fg-disabled flex size-full items-center justify-end",children:r})]})}}):e.jsx(ie,{context:t,disabledToggleTooltip:l("inventory.stock.disabledToggleTooltip"),placeholder:l("inventory.stock.placeholder")})}}))],[n,a,l])},Ce=N({id:Z().optional(),quantity:ke([Se(),Z()]),checked:Y(),disabledToggle:Y()}),qe=I(Ce),Ee=N({locations:qe}),ze=N({inventory_items:I(Ee)}),Re=N({variants:I(ze)}),Le=({variants:n,locations:o,onLoaded:l})=>{const{t:a}=P(),{handleSuccess:s,setCloseOnEscape:t}=de(),i=Ne();f.useEffect(()=>{l()},[l]);const[c,d]=f.useState(!1),u=ve({defaultValues:J(n,o),resolver:_e(Re)}),m=f.useRef(J(n,o)),r=f.useMemo(()=>Pe(n),[n]),j=Ie(o,r),{mutateAsync:b,isPending:g}=pe(),X=u.handleSubmit(async w=>{var C,q,E,z,R,L,V,F,K,O,$,G,H,M;const p={create:[],update:[],delete:[],force:!0};for(const[x,ee]of Object.entries(w.variants))for(const[_,te]of Object.entries(ee.inventory_items))for(const[k,y]of Object.entries(te.locations)){if(y.id)if(((V=(L=(R=(z=(E=(q=(C=m.current)==null?void 0:C.variants)==null?void 0:q[x])==null?void 0:E.inventory_items)==null?void 0:z[_])==null?void 0:R.locations)==null?void 0:L[k])==null?void 0:V.checked)&&!y.checked)p.delete.push(y.id);else{const U=y.quantity!==""?B(y.quantity):0,se=(M=(H=(G=($=(O=(K=(F=m.current)==null?void 0:F.variants)==null?void 0:K[x])==null?void 0:O.inventory_items)==null?void 0:$[_])==null?void 0:G.locations)==null?void 0:H[k])==null?void 0:M.quantity;U!==se&&p.update.push({inventory_item_id:_,location_id:k,stocked_quantity:U})}!y.id&&y.quantity!==""&&p.create.push({inventory_item_id:_,location_id:k,stocked_quantity:B(y.quantity)})}if(p.delete.length>0){d(!0);const x=await i({title:a("general.areYouSure"),description:a("inventory.stock.disablePrompt",{count:p.delete.length}),confirmText:a("actions.continue"),cancelText:a("actions.cancel"),variant:"confirmation"});if(d(!1),!x)return}await b(p,{onSuccess:()=>{A.success(a("inventory.stock.successToast")),s()},onError:x=>{A.error(x.message)}})});return e.jsx(h.Form,{form:u,children:e.jsxs(ce,{onSubmit:X,className:"flex size-full flex-col",children:[e.jsx(h.Header,{}),e.jsx(h.Body,{className:"flex flex-col overflow-hidden",children:e.jsx(ne,{state:u,columns:j,data:n,getSubRows:Ve,onEditingChange:w=>t(!w),disableInteractions:g||c,multiColumnSelection:!0})}),e.jsx(h.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(h.Close,{asChild:!0,children:e.jsx(Q,{variant:"secondary",size:"small",type:"button",children:a("actions.cancel")})}),e.jsx(Q,{type:"submit",size:"small",isLoading:g,children:a("actions.save")})]})})]})})};function Ve(n){if(De(n))return n.inventory_items}function J(n,o){return{variants:n.reduce((l,a)=>{var t;const s=(t=a.inventory_items)==null?void 0:t.reduce((i,c)=>{const d=o.reduce((u,m)=>{var j,b;const r=(b=(j=c.inventory)==null?void 0:j.location_levels)==null?void 0:b.find(g=>g.location_id===m.id);return u[m.id]={id:r==null?void 0:r.id,quantity:(r==null?void 0:r.stocked_quantity)!==void 0?r==null?void 0:r.stocked_quantity:"",checked:!!r,disabledToggle:((r==null?void 0:r.incoming_quantity)||0)>0||((r==null?void 0:r.reserved_quantity)||0)>0},u},{});return i[c.inventory_item_id]={locations:d},i},{});return l[a.id]={inventory_items:s||{}},l},{})}}var tt=()=>{const{t:n}=P(),o=ue(),[l,a]=f.useState(!1),s=f.useRef();f.useEffect(()=>(s.current=setTimeout(()=>{a(!0)},200),()=>{s.current&&clearTimeout(s.current)}),[]);const t=()=>{s.current&&clearTimeout(s.current),a(!1)};return e.jsxs("div",{children:[e.jsx("div",{className:"fixed inset-x-0 top-0 z-50 h-1",children:e.jsx(me,{children:l?e.jsx(fe,{duration:5}):null})}),e.jsxs(h,{children:[e.jsx(h.Title,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:n("products.stock.heading")})}),e.jsx(h.Description,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:n("products.stock.description")})}),e.jsx(f.Suspense,{fallback:e.jsx(Fe,{}),children:e.jsx(ye,{resolve:o.data,children:i=>e.jsx(Le,{variants:i.variants,locations:i.locations,onLoaded:t})})})]})]})},Fe=()=>e.jsx("div",{className:"relative flex size-full flex-col items-center justify-center divide-y",children:e.jsxs("div",{className:"flex size-full flex-col divide-y",children:[e.jsx("div",{className:"px-4 py-2",children:e.jsx(T,{className:"h-7 w-7"})}),e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsx(ae,{columns:Array.from({length:10})})}),e.jsxs("div",{className:"bg-ui-bg-base flex items-center justify-end gap-x-2 p-4",children:[e.jsx(T,{className:"h-7 w-[59px]"}),e.jsx(T,{className:"h-7 w-[46px]"})]})]})});export{tt as Component,et as loader};
